<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="generator" content="mkdocs-1.6.1, mkdocs-terminal-4.7.0">
    
    <meta name="description" content="Documentation for the Floxide framework - A type-safe, composable directed graph workflow system written in Rust"> 
    
    <meta name="author" content="Floxide Team"> 
    <link rel="icon" type="image/png" sizes="192x192" href="../../img/android-chrome-192x192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="../../img/android-chrome-512x512.png" />
<link rel="apple-touch-icon" sizes="180x180" href="../../img/apple-touch-icon.png" />
<link rel="shortcut icon" type="image/png" sizes="48x48" href="../../img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="../../img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="../../img/favicon-32x32.png" />


    
 
<title>ADR-0017: Event-Driven Node Pattern - Floxide Documentation</title>


<link href="../../css/fontawesome/css/fontawesome.min.css" rel="stylesheet">
<link href="../../css/fontawesome/css/solid.min.css" rel="stylesheet">
<link href="../../css/normalize.css" rel="stylesheet">
<link href="../../css/terminal.css" rel="stylesheet">
<link href="../../css/theme.css" rel="stylesheet">
<link href="../../css/theme.tile_grid.css" rel="stylesheet">
<link href="../../css/theme.footer.css" rel="stylesheet">
<!-- dark color palette -->
<link href="../../css/palettes/dark.css" rel="stylesheet">

<!-- page layout -->
<style>
/* initially set page layout to a one column grid */
.terminal-mkdocs-main-grid {
    display: grid;
    grid-column-gap: 1.4em;
    grid-template-columns: auto;
    grid-template-rows: auto;
}

/*  
*   when side navigation is not hidden, use a two column grid.  
*   if the screen is too narrow, fall back to the initial one column grid layout.
*   in this case the main content will be placed under the navigation panel. 
*/
@media only screen and (min-width: 70em) {
    .terminal-mkdocs-main-grid {
        grid-template-columns: 4fr 9fr;
    }
}</style>



    
    <link href="../../css/extra.css" rel="stylesheet">  
    
    

    
    <!-- search css support -->
<link href="../../css/search/bootstrap-modal.css" rel="stylesheet">
<!-- search scripts -->
<script>
    var base_url = "../..",
    shortcuts = "{}";
</script>
<script src="../../js/jquery/jquery-1.10.1.min.js" defer></script>
<script src="../../js/bootstrap/bootstrap.min.js" defer></script>
<script src="../../js/mkdocs/base.js" defer></script>
    
    
    
    
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <script src="../../search/main.js"></script>
    

    
</head>

<body class="terminal"><div class="container">
    <div class="terminal-nav">
        <header class="terminal-logo">
            <div id="mkdocs-terminal-site-name" class="logo terminal-prompt"><a href="/" class="no-style">Floxide Documentation</a></div>
        </header>
        
        <nav class="terminal-menu">
            
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../.." class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Home</span>
                    </a>
                    <meta property="position" content="0">
                </li>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../../contributing/" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Contributing</span>
                    </a>
                    <meta property="position" content="1">
                </li>
                
                    
                    


<li property="itemListElement" typeof="ListItem">
    <a href="#" class="menu-item" data-toggle="modal" data-target="#mkdocs_search_modal" property="item" typeof="SearchAction">
        <i aria-hidden="true" class="fa fa-search"></i> <span property="name">Search</span>
    </a>
    <meta property="position" content="2">
</li>
                    
            </ul>
            
        </nav>
    </div>
</div>
        
    <div class="container">
        <div class="terminal-mkdocs-main-grid"><aside id="terminal-mkdocs-side-panel"><nav>
  
    <ul class="terminal-mkdocs-side-nav-items">
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../..">Home</a>
        
    
    
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Getting Started</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../getting-started/installation/">Installation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../getting-started/quick-start/">Quick Start</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../getting-started/error-handling/">Error Handling</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Core Concepts</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/overview/">Overview</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/nodes/">Nodes</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/workflows/">Workflows</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/actions/">Actions</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/contexts/">Contexts</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Guides</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../guides/event_driven_architecture/">Event-Driven Architecture</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../guides/using-mermaid-diagrams/">Using Mermaid Diagrams</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Examples</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/basic-workflow/">Basic Workflow</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/event-driven-workflow/">Event-Driven Workflow</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/timer-node/">Timer Node</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/reactive-node/">Reactive Node</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/transform-node/">Transform Node</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/longrunning-node/">Long-Running Node</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/batch-processing/">Batch Processing</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Architecture</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/adr-process/">ADR Process</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/core-framework-abstractions/">Core Framework Abstractions</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/project-structure/">Project Structure</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/async-runtime-selection/">Async Runtime Selection</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/node-lifecycle-methods/">Node Lifecycle Methods</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/event-driven-workflow-pattern/">Event-Driven Workflow Pattern</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/reactive-node-implementation/">Reactive Node Implementation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/timer-node-implementation/">Timer Node Implementation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/longrunning-node-implementation/">Long-Running Node Implementation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/transform-node-implementation/">Transform Node Implementation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/batch-processing-implementation/">Batch Processing Implementation</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">API Reference</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-core/">floxide-core</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-transform/">floxide-transform</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-event/">floxide-event</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-timer/">floxide-timer</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-reactive/">floxide-reactive</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-longrunning/">floxide-longrunning</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-batch/">floxide-batch</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../contributing/">Contributing</a>
        
    
    
    
  </li>
        
    </ul>
  
</nav><hr>
<nav>
    <ul>
        <li><a href="#adr-0017-event-driven-node-pattern">ADR-0017: Event-Driven Node Pattern</a></li>
        <li><a href="#status">Status</a></li><li><a href="#date">Date</a></li><li><a href="#context">Context</a></li><li><a href="#decision">Decision</a></li><li><a href="#consequences">Consequences</a></li><li><a href="#alternatives-considered">Alternatives Considered</a></li><li><a href="#implementation-notes">Implementation Notes</a></li><li><a href="#related-adrs">Related ADRs</a></li><li><a href="#references">References</a></li>
    </ul>
</nav>
</aside>
            <main id="terminal-mkdocs-main-content">
<section id="mkdocs-terminal-content">
    <h1 id="adr-0017-event-driven-node-pattern">ADR-0017: Event-Driven Node Pattern<a class="headerlink" href="#adr-0017-event-driven-node-pattern" title="Permanent link">&para;</a></h1>
<h2 id="status">Status<a class="headerlink" href="#status" title="Permanent link">&para;</a></h2>
<p>Proposed</p>
<h2 id="date">Date<a class="headerlink" href="#date" title="Permanent link">&para;</a></h2>
<p>2025-02-27</p>
<h2 id="context">Context<a class="headerlink" href="#context" title="Permanent link">&para;</a></h2>
<p>The Floxide framework currently supports synchronous workflow execution where each node processes input and produces output through a direct call chain. While this model works well for deterministic, sequential workflows, it lacks support for:</p>
<ol>
<li>Workflows that need to wait for external events without blocking system resources</li>
<li>Long-running workflows that respond to events as they arrive</li>
<li>Integration with event sources like message queues, webhooks, or system signals</li>
<li>Building reactive systems that can respond to changes in real-time</li>
</ol>
<p>The existing node abstractions (<code>Node</code>, <code>LifecycleNode</code>, and <code>TransformNode</code>) all assume that processing is initiated by the workflow engine and completes within a single execution context. They don't provide a natural way to express nodes that wait for events or react to external stimuli.</p>
<p>Additionally, since the framework operates within a single process, we need an event-driven pattern that:</p>
<ul>
<li>Works efficiently within a shared memory space</li>
<li>Can be nested within other workflows</li>
<li>Provides clean integration with the existing workflow engine</li>
<li>Maintains type safety and the functional approach of the framework</li>
</ul>
<h2 id="decision">Decision<a class="headerlink" href="#decision" title="Permanent link">&para;</a></h2>
<p>We will implement the <code>EventDrivenNode</code> trait to enable event-driven workflows within the Floxide framework. This trait will be designed to:</p>
<ol>
<li>Allow nodes to wait for events without blocking threads</li>
<li>Process events as they arrive</li>
<li>Integrate smoothly with the existing workflow system</li>
<li>Support nesting within larger workflows</li>
</ol>
<h3 id="eventdrivennode-trait">EventDrivenNode Trait<a class="headerlink" href="#eventdrivennode-trait" title="Permanent link">&para;</a></h3>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-0-1"><span class="cp">#[async_trait]</span>
</span><span id="__span-0-2"><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">EventDrivenNode</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span>
</span><span id="__span-0-3"><span class="k">where</span>
</span><span id="__span-0-4"><span class="w">    </span><span class="n">Event</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-0-5"><span class="w">    </span><span class="n">Context</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-0-6"><span class="w">    </span><span class="n">Action</span><span class="p">:</span><span class="w"> </span><span class="nc">ActionType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-0-7"><span class="p">{</span>
</span><span id="__span-0-8"><span class="w">    </span><span class="sd">/// Wait for an external event to occur</span>
</span><span id="__span-0-9"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">wait_for_event</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">FloxideError</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-0-10">
</span><span id="__span-0-11"><span class="w">    </span><span class="sd">/// Process the received event and update context</span>
</span><span id="__span-0-12"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">process_event</span><span class="p">(</span>
</span><span id="__span-0-13"><span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
</span><span id="__span-0-14"><span class="w">        </span><span class="n">event</span><span class="p">:</span><span class="w"> </span><span class="nc">Event</span><span class="p">,</span>
</span><span id="__span-0-15"><span class="w">        </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span>
</span><span id="__span-0-16"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Action</span><span class="p">,</span><span class="w"> </span><span class="n">FloxideError</span><span class="o">&gt;</span><span class="p">;</span>
</span><span id="__span-0-17">
</span><span id="__span-0-18"><span class="w">    </span><span class="sd">/// Get the node&#39;s unique identifier</span>
</span><span id="__span-0-19"><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">NodeId</span><span class="p">;</span>
</span><span id="__span-0-20"><span class="p">}</span>
</span></code></pre></div>
<h3 id="event-sources">Event Sources<a class="headerlink" href="#event-sources" title="Permanent link">&para;</a></h3>
<p>To provide flexibility in event sources, we'll define common event source adapters:</p>
<ol>
<li><strong>Channel-based Events</strong>: Using Tokio channels for in-process communication</li>
<li><strong>Timer Events</strong>: For time-based triggers using interval or cron expressions</li>
<li><strong>External Source Adapters</strong>: For connecting to external systems like message queues</li>
</ol>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-1-1"><span class="c1">// Channel-based event source</span>
</span><span id="__span-1-2"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ChannelEventSource</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-3"><span class="w">    </span><span class="n">receiver</span><span class="p">:</span><span class="w"> </span><span class="nc">mpsc</span><span class="p">::</span><span class="n">Receiver</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span><span class="p">,</span>
</span><span id="__span-1-4"><span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="nc">NodeId</span><span class="p">,</span>
</span><span id="__span-1-5"><span class="p">}</span>
</span><span id="__span-1-6">
</span><span id="__span-1-7"><span class="k">impl</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ChannelEventSource</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span>
</span><span id="__span-1-8"><span class="k">where</span>
</span><span id="__span-1-9"><span class="w">    </span><span class="n">Event</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-1-10"><span class="p">{</span>
</span><span id="__span-1-11"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">capacity</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">Self</span><span class="p">,</span><span class="w"> </span><span class="n">mpsc</span><span class="p">::</span><span class="n">Sender</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-12"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">receiver</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mpsc</span><span class="p">::</span><span class="n">channel</span><span class="p">(</span><span class="n">capacity</span><span class="p">);</span>
</span><span id="__span-1-13"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uuid</span><span class="p">::</span><span class="n">new_v4</span><span class="p">().</span><span class="n">to_string</span><span class="p">();</span>
</span><span id="__span-1-14"><span class="w">        </span><span class="p">(</span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">receiver</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">sender</span><span class="p">)</span>
</span><span id="__span-1-15"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-16"><span class="p">}</span>
</span><span id="__span-1-17">
</span><span id="__span-1-18"><span class="cp">#[async_trait]</span>
</span><span id="__span-1-19"><span class="k">impl</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EventDrivenNode</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ChannelEventSource</span><span class="o">&lt;</span><span class="n">Event</span><span class="o">&gt;</span>
</span><span id="__span-1-20"><span class="k">where</span>
</span><span id="__span-1-21"><span class="w">    </span><span class="n">Event</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-1-22"><span class="w">    </span><span class="n">Context</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-1-23"><span class="w">    </span><span class="n">Action</span><span class="p">:</span><span class="w"> </span><span class="nc">ActionType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-1-24"><span class="p">{</span>
</span><span id="__span-1-25"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">wait_for_event</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">FloxideError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-26"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">receiver</span><span class="p">.</span><span class="n">recv</span><span class="p">().</span><span class="k">await</span><span class="p">.</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">FloxideError</span><span class="p">::</span><span class="n">event_source</span><span class="p">(</span>
</span><span id="__span-1-27"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">id</span><span class="p">(),</span>
</span><span id="__span-1-28"><span class="w">            </span><span class="s">&quot;Event channel closed&quot;</span>
</span><span id="__span-1-29"><span class="w">        </span><span class="p">))</span>
</span><span id="__span-1-30"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-31">
</span><span id="__span-1-32"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">process_event</span><span class="p">(</span>
</span><span id="__span-1-33"><span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
</span><span id="__span-1-34"><span class="w">        </span><span class="n">event</span><span class="p">:</span><span class="w"> </span><span class="nc">Event</span><span class="p">,</span>
</span><span id="__span-1-35"><span class="w">        </span><span class="n">_ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span>
</span><span id="__span-1-36"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Action</span><span class="p">,</span><span class="w"> </span><span class="n">FloxideError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-37"><span class="w">        </span><span class="c1">// Default implementation just forwards the event</span>
</span><span id="__span-1-38"><span class="w">        </span><span class="c1">// Users should implement their own event processors</span>
</span><span id="__span-1-39"><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Action</span><span class="p">::</span><span class="n">default</span><span class="p">())</span>
</span><span id="__span-1-40"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-41">
</span><span id="__span-1-42"><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">NodeId</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-43"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="__span-1-44"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-45"><span class="p">}</span>
</span></code></pre></div>
<h3 id="eventdrivenworkflow">EventDrivenWorkflow<a class="headerlink" href="#eventdrivenworkflow" title="Permanent link">&para;</a></h3>
<p>To execute event-driven nodes, we'll introduce an <code>EventDrivenWorkflow</code> that:</p>
<ol>
<li>Manages the event loop for event-driven nodes</li>
<li>Handles routing between event-driven nodes</li>
<li>Provides graceful shutdown capabilities</li>
<li>Integrates with the standard workflow system</li>
</ol>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-2-1"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">EventDrivenWorkflow</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;</span>
</span><span id="__span-2-2"><span class="k">where</span>
</span><span id="__span-2-3"><span class="w">    </span><span class="n">Event</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-2-4"><span class="w">    </span><span class="n">Context</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-2-5"><span class="w">    </span><span class="n">Action</span><span class="p">:</span><span class="w"> </span><span class="nc">ActionType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-2-6"><span class="p">{</span>
</span><span id="__span-2-7"><span class="w">    </span><span class="n">nodes</span><span class="p">:</span><span class="w"> </span><span class="nc">HashMap</span><span class="o">&lt;</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">EventDrivenNode</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
</span><span id="__span-2-8"><span class="w">    </span><span class="n">routes</span><span class="p">:</span><span class="w"> </span><span class="nc">HashMap</span><span class="o">&lt;</span><span class="p">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">ActionType</span><span class="p">),</span><span class="w"> </span><span class="n">NodeId</span><span class="o">&gt;</span><span class="p">,</span>
</span><span id="__span-2-9"><span class="w">    </span><span class="n">initial_node</span><span class="p">:</span><span class="w"> </span><span class="nc">NodeId</span><span class="p">,</span>
</span><span id="__span-2-10"><span class="p">}</span>
</span><span id="__span-2-11">
</span><span id="__span-2-12"><span class="k">impl</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;</span><span class="w"> </span><span class="n">EventDrivenWorkflow</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;</span>
</span><span id="__span-2-13"><span class="k">where</span>
</span><span id="__span-2-14"><span class="w">    </span><span class="n">Event</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-2-15"><span class="w">    </span><span class="n">Context</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-2-16"><span class="w">    </span><span class="n">Action</span><span class="p">:</span><span class="w"> </span><span class="nc">ActionType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-2-17"><span class="p">{</span>
</span><span id="__span-2-18"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">initial_node</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">EventDrivenNode</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-19"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">initial_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initial_node</span><span class="p">.</span><span class="n">id</span><span class="p">();</span>
</span><span id="__span-2-20"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
</span><span id="__span-2-21"><span class="w">        </span><span class="n">nodes</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">initial_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">initial_node</span><span class="p">);</span>
</span><span id="__span-2-22">
</span><span id="__span-2-23"><span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-24"><span class="w">            </span><span class="n">nodes</span><span class="p">,</span>
</span><span id="__span-2-25"><span class="w">            </span><span class="n">routes</span><span class="p">:</span><span class="w"> </span><span class="nc">HashMap</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
</span><span id="__span-2-26"><span class="w">            </span><span class="n">initial_node</span><span class="p">:</span><span class="w"> </span><span class="nc">initial_id</span><span class="p">,</span>
</span><span id="__span-2-27"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-28"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-29">
</span><span id="__span-2-30"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">add_node</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">EventDrivenNode</span><span class="o">&lt;</span><span class="n">Event</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">Action</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-31"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">();</span>
</span><span id="__span-2-32"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p">);</span>
</span><span id="__span-2-33"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-34">
</span><span id="__span-2-35"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">set_route</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">from_id</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">action</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Action</span><span class="p">,</span><span class="w"> </span><span class="n">to_id</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">NodeId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-36"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">routes</span><span class="p">.</span><span class="n">insert</span><span class="p">((</span><span class="n">from_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">action</span><span class="p">.</span><span class="n">clone</span><span class="p">()),</span><span class="w"> </span><span class="n">to_id</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
</span><span id="__span-2-37"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-38">
</span><span id="__span-2-39"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">FloxideError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-40"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">current_node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">initial_node</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
</span><span id="__span-2-41">
</span><span id="__span-2-42"><span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-43"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nodes</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_node_id</span><span class="p">).</span><span class="n">ok_or_else</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-44"><span class="w">                </span><span class="n">FloxideError</span><span class="p">::</span><span class="n">node_not_found</span><span class="p">(</span><span class="n">current_node_id</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span>
</span><span id="__span-2-45"><span class="w">            </span><span class="p">})</span><span class="o">?</span><span class="p">;</span>
</span><span id="__span-2-46">
</span><span id="__span-2-47"><span class="w">            </span><span class="c1">// Wait for an event</span>
</span><span id="__span-2-48"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">wait_for_event</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
</span><span id="__span-2-49">
</span><span id="__span-2-50"><span class="w">            </span><span class="c1">// Process the event</span>
</span><span id="__span-2-51"><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">process_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
</span><span id="__span-2-52">
</span><span id="__span-2-53"><span class="w">            </span><span class="c1">// Check for termination action</span>
</span><span id="__span-2-54"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Action</span><span class="p">::</span><span class="n">terminate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-55"><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-2-56"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-2-57">
</span><span id="__span-2-58"><span class="w">            </span><span class="c1">// Route to the next node</span>
</span><span id="__span-2-59"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">next_node_id</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">routes</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">current_node_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">action</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-60"><span class="w">                </span><span class="n">current_node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_node_id</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
</span><span id="__span-2-61"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-62"><span class="w">                </span><span class="c1">// Stay on the same node if no route is defined for this action</span>
</span><span id="__span-2-63"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-2-64"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-65">
</span><span id="__span-2-66"><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
</span><span id="__span-2-67"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-68">
</span><span id="__span-2-69"><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">execute_with_timeout</span><span class="p">(</span>
</span><span id="__span-2-70"><span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
</span><span id="__span-2-71"><span class="w">        </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span>
</span><span id="__span-2-72"><span class="w">        </span><span class="n">timeout</span><span class="p">:</span><span class="w"> </span><span class="nc">Duration</span>
</span><span id="__span-2-73"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">FloxideError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-74"><span class="w">        </span><span class="n">tokio</span><span class="p">::</span><span class="n">select</span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-75"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">result</span><span class="p">,</span>
</span><span id="__span-2-76"><span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span><span class="p">::</span><span class="n">time</span><span class="p">::</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-77"><span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">FloxideError</span><span class="p">::</span><span class="n">timeout</span><span class="p">(</span><span class="s">&quot;Event-driven workflow execution timed out&quot;</span><span class="p">))</span>
</span><span id="__span-2-78"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-2-79"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-80"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-81"><span class="p">}</span>
</span></code></pre></div>
<h3 id="integration-with-standard-workflows">Integration with Standard Workflows<a class="headerlink" href="#integration-with-standard-workflows" title="Permanent link">&para;</a></h3>
<p>We'll provide adapter patterns to integrate event-driven nodes with standard workflows:</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-3-1"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">EventDrivenNodeAdapter</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span>
</span><span id="__span-3-2"><span class="k">where</span>
</span><span id="__span-3-3"><span class="w">    </span><span class="n">E</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-3-4"><span class="w">    </span><span class="n">C</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-3-5"><span class="w">    </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="nc">ActionType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-3-6"><span class="p">{</span>
</span><span id="__span-3-7"><span class="w">    </span><span class="n">node</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">EventDrivenNode</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span id="__span-3-8"><span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="nc">NodeId</span><span class="p">,</span>
</span><span id="__span-3-9"><span class="w">    </span><span class="n">timeout</span><span class="p">:</span><span class="w"> </span><span class="nc">Duration</span><span class="p">,</span>
</span><span id="__span-3-10"><span class="p">}</span>
</span><span id="__span-3-11">
</span><span id="__span-3-12"><span class="cp">#[async_trait]</span>
</span><span id="__span-3-13"><span class="k">impl</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">EventDrivenNodeAdapter</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span>
</span><span id="__span-3-14"><span class="k">where</span>
</span><span id="__span-3-15"><span class="w">    </span><span class="n">E</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-3-16"><span class="w">    </span><span class="n">C</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-3-17"><span class="w">    </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="nc">ActionType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-3-18"><span class="p">{</span>
</span><span id="__span-3-19"><span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-3-20">
</span><span id="__span-3-21"><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">NodeId</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-22"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="__span-3-23"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-24">
</span><span id="__span-3-25"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">NodeOutcome</span><span class="o">&lt;</span><span class="bp">Self</span><span class="p">::</span><span class="n">Output</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">FloxideError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-26"><span class="w">        </span><span class="c1">// Wait for one event with timeout</span>
</span><span id="__span-3-27"><span class="w">        </span><span class="n">tokio</span><span class="p">::</span><span class="n">select</span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-28"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">wait_for_event</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-29"><span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-30"><span class="w">                    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-31"><span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">process_event</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
</span><span id="__span-3-32"><span class="w">                        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">NodeOutcome</span><span class="p">::</span><span class="n">RouteToAction</span><span class="p">((),</span><span class="w"> </span><span class="n">action</span><span class="p">))</span>
</span><span id="__span-3-33"><span class="w">                    </span><span class="p">},</span>
</span><span id="__span-3-34"><span class="w">                    </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
</span><span id="__span-3-35"><span class="w">                </span><span class="p">}</span>
</span><span id="__span-3-36"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-37"><span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span><span class="p">::</span><span class="n">time</span><span class="p">::</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-38"><span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">NodeOutcome</span><span class="p">::</span><span class="n">RouteToAction</span><span class="p">((),</span><span class="w"> </span><span class="n">A</span><span class="p">::</span><span class="n">timeout</span><span class="p">()))</span>
</span><span id="__span-3-39"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-3-40"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-3-41"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-42"><span class="p">}</span>
</span></code></pre></div>
<h3 id="nested-event-driven-workflows">Nested Event-Driven Workflows<a class="headerlink" href="#nested-event-driven-workflows" title="Permanent link">&para;</a></h3>
<p>To support nested event-driven workflows within larger workflows, we'll provide:</p>
<div class="language-rust highlight"><pre><span></span><code><span id="__span-4-1"><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">NestedEventDrivenWorkflow</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span>
</span><span id="__span-4-2"><span class="k">where</span>
</span><span id="__span-4-3"><span class="w">    </span><span class="n">E</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-4-4"><span class="w">    </span><span class="n">C</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-4-5"><span class="w">    </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="nc">ActionType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-4-6"><span class="p">{</span>
</span><span id="__span-4-7"><span class="w">    </span><span class="n">workflow</span><span class="p">:</span><span class="w"> </span><span class="nc">Arc</span><span class="o">&lt;</span><span class="n">EventDrivenWorkflow</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span id="__span-4-8"><span class="w">    </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="nc">NodeId</span><span class="p">,</span>
</span><span id="__span-4-9"><span class="w">    </span><span class="n">timeout</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Duration</span><span class="o">&gt;</span><span class="p">,</span>
</span><span id="__span-4-10"><span class="p">}</span>
</span><span id="__span-4-11">
</span><span id="__span-4-12"><span class="cp">#[async_trait]</span>
</span><span id="__span-4-13"><span class="k">impl</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Node</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">NestedEventDrivenWorkflow</span><span class="o">&lt;</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span>
</span><span id="__span-4-14"><span class="k">where</span>
</span><span id="__span-4-15"><span class="w">    </span><span class="n">E</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-4-16"><span class="w">    </span><span class="n">C</span><span class="p">:</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-4-17"><span class="w">    </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="nc">ActionType</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Sync</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">&#39;</span><span class="nb">static</span><span class="p">,</span>
</span><span id="__span-4-18"><span class="p">{</span>
</span><span id="__span-4-19"><span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>
</span><span id="__span-4-20">
</span><span id="__span-4-21"><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">NodeId</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-22"><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
</span><span id="__span-4-23"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-24">
</span><span id="__span-4-25"><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">NodeOutcome</span><span class="o">&lt;</span><span class="bp">Self</span><span class="p">::</span><span class="n">Output</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">FloxideError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-26"><span class="w">        </span><span class="c1">// Execute the workflow, optionally with a timeout</span>
</span><span id="__span-4-27"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">timeout</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-28"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">workflow</span><span class="p">.</span><span class="n">execute_with_timeout</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">timeout</span><span class="p">).</span><span class="k">await</span>
</span><span id="__span-4-29"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-30"><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">workflow</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ctx</span><span class="p">).</span><span class="k">await</span>
</span><span id="__span-4-31"><span class="w">        </span><span class="p">};</span>
</span><span id="__span-4-32">
</span><span id="__span-4-33"><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-34"><span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">NodeOutcome</span><span class="p">::</span><span class="n">RouteToAction</span><span class="p">((),</span><span class="w"> </span><span class="n">A</span><span class="p">::</span><span class="n">complete</span><span class="p">())),</span>
</span><span id="__span-4-35"><span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-36"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">is_timeout</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-37"><span class="w">                    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">NodeOutcome</span><span class="p">::</span><span class="n">RouteToAction</span><span class="p">((),</span><span class="w"> </span><span class="n">A</span><span class="p">::</span><span class="n">timeout</span><span class="p">()))</span>
</span><span id="__span-4-38"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-39"><span class="w">                    </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="__span-4-40"><span class="w">                </span><span class="p">}</span>
</span><span id="__span-4-41"><span class="w">            </span><span class="p">}</span>
</span><span id="__span-4-42"><span class="w">        </span><span class="p">}</span>
</span><span id="__span-4-43"><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-44"><span class="p">}</span>
</span></code></pre></div>
<h2 id="consequences">Consequences<a class="headerlink" href="#consequences" title="Permanent link">&para;</a></h2>
<h3 id="advantages">Advantages<a class="headerlink" href="#advantages" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Event-Driven Workflows</strong>: Enables building reactive systems that respond to events</li>
<li><strong>Resource Efficiency</strong>: Nodes can wait for events without blocking threads</li>
<li><strong>Integration</strong>: Clean integration with the existing workflow engine</li>
<li><strong>Nesting Support</strong>: Event-driven workflows can be nested within larger workflows</li>
<li><strong>Type Safety</strong>: Maintains the type safety of the framework</li>
<li><strong>Flexibility</strong>: Works with various event sources (channels, timers, external systems)</li>
<li><strong>Composability</strong>: Event-driven nodes can be combined with other node types</li>
</ol>
<h3 id="disadvantages">Disadvantages<a class="headerlink" href="#disadvantages" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Complexity</strong>: Adds more abstractions to the framework</li>
<li><strong>Concurrency Challenges</strong>: Event-driven code can be harder to reason about</li>
<li><strong>State Management</strong>: Stateful event-driven nodes require careful management</li>
<li><strong>Learning Curve</strong>: Users need to understand both workflows and event handling</li>
</ol>
<h3 id="implementation-plan">Implementation Plan<a class="headerlink" href="#implementation-plan" title="Permanent link">&para;</a></h3>
<p>The implementation will be phased:</p>
<ol>
<li>Phase 1: Core <code>EventDrivenNode</code> trait and basic channel-based event sources</li>
<li>Phase 2: Integration with standard workflows and nesting support</li>
<li>Phase 3: Advanced event sources (timers, external system adapters)</li>
<li>Phase 4: Expanded examples and documentation</li>
</ol>
<h2 id="alternatives-considered">Alternatives Considered<a class="headerlink" href="#alternatives-considered" title="Permanent link">&para;</a></h2>
<h3 id="1-using-actors-instead-of-event-driven-nodes">1. Using Actors Instead of Event-Driven Nodes<a class="headerlink" href="#1-using-actors-instead-of-event-driven-nodes" title="Permanent link">&para;</a></h3>
<p>We considered using an actor model (similar to Akka or Actix) where each node is an actor that processes messages. This would provide a different concurrency model but would add significant complexity to the framework.</p>
<h3 id="2-event-loops-in-standard-nodes">2. Event Loops in Standard Nodes<a class="headerlink" href="#2-event-loops-in-standard-nodes" title="Permanent link">&para;</a></h3>
<p>We evaluated adding event loop capabilities to standard nodes, allowing them to optionally wait for events. This would avoid adding a new trait but would make the existing traits more complex and harder to use correctly.</p>
<h3 id="3-external-event-processing">3. External Event Processing<a class="headerlink" href="#3-external-event-processing" title="Permanent link">&para;</a></h3>
<p>Another approach would be to handle events externally and feed them into the workflow through standard inputs. This would be simpler but would not provide the full reactivity benefits of true event-driven nodes.</p>
<h3 id="4-workflow-level-event-handling">4. Workflow-level Event Handling<a class="headerlink" href="#4-workflow-level-event-handling" title="Permanent link">&para;</a></h3>
<p>Instead of event-driven nodes, we considered adding event handling at the workflow level only. This would be simpler but would not allow the fine-grained control of having event handling at the node level.</p>
<h2 id="implementation-notes">Implementation Notes<a class="headerlink" href="#implementation-notes" title="Permanent link">&para;</a></h2>
<ul>
<li>The <code>EventDrivenNode</code> trait will be implemented in the new <code>floxide-event</code> crate</li>
<li>Channel-based event sources will use Tokio's MPSC channels for efficiency</li>
<li>Event-driven workflows will be cancelable and support graceful shutdown</li>
<li>Type parameters on event-driven nodes allow for custom event types per workflow</li>
<li>Events must be <code>Send + 'static</code> to support async processing across threads</li>
</ul>
<h2 id="related-adrs">Related ADRs<a class="headerlink" href="#related-adrs" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../0003-core-framework-abstractions/">ADR-0003: Core Framework Abstractions</a></li>
<li><a href="../0004-async-runtime-selection/">ADR-0004: Async Runtime Selection</a></li>
<li><a href="../0015-node-abstraction-hierarchy/">ADR-0015: Node Abstraction Hierarchy</a></li>
<li><a href="../0016-transform-node-and-async-extensions/">ADR-0016: TransformNode Renaming and Async Extension Patterns</a></li>
</ul>
<h2 id="references">References<a class="headerlink" href="#references" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://tokio.rs/">Tokio: Asynchronous Programming for Rust</a></li>
<li><a href="https://www.reactivemanifesto.org/">The Reactive Manifesto</a></li>
<li><a href="https://www.confluent.io/designing-event-driven-systems/">Designing event-driven systems</a></li>
<li><a href="https://en.wikipedia.org/wiki/Event-driven_architecture">Event-driven architecture</a></li>
</ul>
</section>

            </main>
        </div>
        <hr><footer>
    <div class="terminal-mkdocs-footer-grid">
        <div id="terminal-mkdocs-footer-copyright-info">
             Site built with <a href="http://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/ntno/mkdocs-terminal">Terminal for MkDocs</a>.
        </div>
    </div>
</footer>
    </div>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="alertdialog" aria-modal="true" aria-labelledby="searchModalLabel">
    <div class="modal-dialog modal-lg" role="search">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Search</h5>
                <button type="button" class="close btn btn-default btn-ghost" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p id="searchInputLabel">Type to start searching</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" aria-labelledby="searchInputLabel" placeholder="" id="mkdocs-search-query" title="Please enter search terms here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No document matches found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    
    
</body>

</html>