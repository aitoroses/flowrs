<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="generator" content="mkdocs-1.6.1, mkdocs-terminal-4.7.0">
    
    <meta name="description" content="Documentation for the Floxide framework - A type-safe, composable directed graph workflow system written in Rust"> 
    
    <meta name="author" content="Floxide Team"> 
    <link rel="icon" type="image/png" sizes="192x192" href="../../img/android-chrome-192x192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="../../img/android-chrome-512x512.png" />
<link rel="apple-touch-icon" sizes="180x180" href="../../img/apple-touch-icon.png" />
<link rel="shortcut icon" type="image/png" sizes="48x48" href="../../img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="../../img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="../../img/favicon-32x32.png" />


    
 
<title>ADR 0030: Workspace Dependency Versioning for Publishing - Floxide Documentation</title>


<link href="../../css/fontawesome/css/fontawesome.min.css" rel="stylesheet">
<link href="../../css/fontawesome/css/solid.min.css" rel="stylesheet">
<link href="../../css/normalize.css" rel="stylesheet">
<link href="../../css/terminal.css" rel="stylesheet">
<link href="../../css/theme.css" rel="stylesheet">
<link href="../../css/theme.tile_grid.css" rel="stylesheet">
<link href="../../css/theme.footer.css" rel="stylesheet">
<!-- dark color palette -->
<link href="../../css/palettes/dark.css" rel="stylesheet">

<!-- page layout -->
<style>
/* initially set page layout to a one column grid */
.terminal-mkdocs-main-grid {
    display: grid;
    grid-column-gap: 1.4em;
    grid-template-columns: auto;
    grid-template-rows: auto;
}

/*  
*   when side navigation is not hidden, use a two column grid.  
*   if the screen is too narrow, fall back to the initial one column grid layout.
*   in this case the main content will be placed under the navigation panel. 
*/
@media only screen and (min-width: 70em) {
    .terminal-mkdocs-main-grid {
        grid-template-columns: 4fr 9fr;
    }
}</style>



    
    <link href="../../css/extra.css" rel="stylesheet">  
    
    

    
    <!-- search css support -->
<link href="../../css/search/bootstrap-modal.css" rel="stylesheet">
<!-- search scripts -->
<script>
    var base_url = "../..",
    shortcuts = "{}";
</script>
<script src="../../js/jquery/jquery-1.10.1.min.js" defer></script>
<script src="../../js/bootstrap/bootstrap.min.js" defer></script>
<script src="../../js/mkdocs/base.js" defer></script>
    
    
    
    
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
    
    <script src="../../search/main.js"></script>
    

    
</head>

<body class="terminal"><div class="container">
    <div class="terminal-nav">
        <header class="terminal-logo">
            <div id="mkdocs-terminal-site-name" class="logo terminal-prompt"><a href="/" class="no-style">Floxide Documentation</a></div>
        </header>
        
        <nav class="terminal-menu">
            
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../.." class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Home</span>
                    </a>
                    <meta property="position" content="0">
                </li>
                
                
                
                
                
                
                
                
                
                
                
                
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../../contributing/" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Contributing</span>
                    </a>
                    <meta property="position" content="1">
                </li>
                
                    
                    


<li property="itemListElement" typeof="ListItem">
    <a href="#" class="menu-item" data-toggle="modal" data-target="#mkdocs_search_modal" property="item" typeof="SearchAction">
        <i aria-hidden="true" class="fa fa-search"></i> <span property="name">Search</span>
    </a>
    <meta property="position" content="2">
</li>
                    
            </ul>
            
        </nav>
    </div>
</div>
        
    <div class="container">
        <div class="terminal-mkdocs-main-grid"><aside id="terminal-mkdocs-side-panel"><nav>
  
    <ul class="terminal-mkdocs-side-nav-items">
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../..">Home</a>
        
    
    
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Getting Started</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../getting-started/installation/">Installation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../getting-started/quick-start/">Quick Start</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../getting-started/error-handling/">Error Handling</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Core Concepts</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/overview/">Overview</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/nodes/">Nodes</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/workflows/">Workflows</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/actions/">Actions</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../core-concepts/contexts/">Contexts</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Guides</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../guides/event_driven_architecture/">Event-Driven Architecture</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../guides/using-mermaid-diagrams/">Using Mermaid Diagrams</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Examples</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/basic-workflow/">Basic Workflow</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/event-driven-workflow/">Event-Driven Workflow</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/timer-node/">Timer Node</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/reactive-node/">Reactive Node</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/transform-node/">Transform Node</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/longrunning-node/">Long-Running Node</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../examples/batch-processing/">Batch Processing</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">Architecture</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/adr-process/">ADR Process</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/core-framework-abstractions/">Core Framework Abstractions</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/project-structure/">Project Structure</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/async-runtime-selection/">Async Runtime Selection</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/node-lifecycle-methods/">Node Lifecycle Methods</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/event-driven-workflow-pattern/">Event-Driven Workflow Pattern</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/reactive-node-implementation/">Reactive Node Implementation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/timer-node-implementation/">Timer Node Implementation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/longrunning-node-implementation/">Long-Running Node Implementation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/transform-node-implementation/">Transform Node Implementation</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../architecture/batch-processing-implementation/">Batch Processing Implementation</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
        
        

        
            
    
        
        
            
            
            <span class="
        
    

    terminal-mkdocs-side-nav-item terminal-mkdocs-side-nav-section-no-index">API Reference</span>
        
    
    
        
      
        
            <ul class="terminal-mkdocs-side-nav-li-ul">
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-core/">floxide-core</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-transform/">floxide-transform</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-event/">floxide-event</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-timer/">floxide-timer</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-reactive/">floxide-reactive</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-longrunning/">floxide-longrunning</a>
        
    
    </li>
            
        
            
            

             
                <li class="terminal-mkdocs-side-nav-li-ul-li">
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../api/floxide-batch/">floxide-batch</a>
        
    
    </li>
            
            
    </ul>
        
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../../contributing/">Contributing</a>
        
    
    
    
  </li>
        
    </ul>
  
</nav><hr>
<nav>
    <ul>
        <li><a href="#adr-0030-workspace-dependency-versioning-for-publishing">ADR 0030: Workspace Dependency Versioning for Publishing</a></li>
        <li><a href="#status">Status</a></li><li><a href="#context">Context</a></li><li><a href="#decision">Decision</a></li><li><a href="#consequences">Consequences</a></li><li><a href="#implementation">Implementation</a></li><li><a href="#related-adrs">Related ADRs</a></li><li><a href="#additional-considerations">Additional Considerations</a></li>
    </ul>
</nav>
</aside>
            <main id="terminal-mkdocs-main-content">
<section id="mkdocs-terminal-content">
    <h1 id="adr-0030-workspace-dependency-versioning-for-publishing">ADR 0030: Workspace Dependency Versioning for Publishing<a class="headerlink" href="#adr-0030-workspace-dependency-versioning-for-publishing" title="Permanent link">&para;</a></h1>
<h2 id="status">Status<a class="headerlink" href="#status" title="Permanent link">&para;</a></h2>
<p>Accepted</p>
<h2 id="context">Context<a class="headerlink" href="#context" title="Permanent link">&para;</a></h2>
<p>When publishing Rust crates to crates.io, all dependencies must have explicit version specifications, even if they are path dependencies within a workspace. This is a requirement of the crates.io publishing process.</p>
<p>In our workspace structure, we have a root <code>floxide</code> crate that depends on several subcrates (<code>floxide-core</code>, <code>floxide-transform</code>, etc.). These dependencies were initially specified only with <code>path</code> attributes, which works fine for local development but causes errors during the publishing process.</p>
<p>The error encountered was:
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1">error: all dependencies must have a version specified when publishing.
</span><span id="__span-0-2">dependency `floxide-core` does not specify a version
</span><span id="__span-0-3">Note: The published dependency will use the version from crates.io,
</span><span id="__span-0-4">the `path` specification will be removed from the dependency declaration.
</span></code></pre></div></p>
<p>Additionally, we need to ensure that when the workspace version changes, we don't have to manually update multiple version specifications throughout the codebase, which would be error-prone and create maintenance overhead.</p>
<p>We also encountered an issue during version bumping where some subcrates had hardcoded versions instead of using workspace inheritance, causing errors like:
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1">error: failed to select a version for the requirement `floxide-event = &quot;^1.0.2&quot;`
</span><span id="__span-1-2">candidate versions found which didn&#39;t match: 1.0.0
</span><span id="__span-1-3">location searched: /home/runner/work/floxide/floxide/crates/floxide-event
</span><span id="__span-1-4">required by package `floxide v1.0.3 (/home/runner/work/floxide/floxide)`
</span></code></pre></div></p>
<h2 id="decision">Decision<a class="headerlink" href="#decision" title="Permanent link">&para;</a></h2>
<p>We will implement a two-part solution to address these versioning issues:</p>
<ol>
<li>
<p><strong>For the root crate's dependencies</strong>: Maintain explicit version specifications for all workspace dependencies in the root <code>Cargo.toml</code> file, in addition to the path specifications. These versions will match the workspace version defined in <code>[workspace.package]</code>.</p>
</li>
<li>
<p><strong>For subcrates</strong>: Ensure all subcrates use workspace inheritance for their versions by using <code>version.workspace = true</code> instead of hardcoded versions.</p>
</li>
</ol>
<p>The dependency specifications in the root crate will follow this pattern:
<div class="language-toml highlight"><pre><span></span><code><span id="__span-2-1"><span class="n">floxide-core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-core&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></p>
<p>To reduce maintenance burden, we will create two scripts:
- <code>scripts/update_dependency_versions.sh</code>: Automatically updates the version specifications in the root Cargo.toml
- <code>scripts/update_subcrate_versions.sh</code>: Ensures all subcrates use workspace inheritance for their versions</p>
<p>Additionally, we will maintain a specific publishing order in our release workflow, where subcrates are published first, followed by the main crate. This ensures that all dependencies are available on crates.io when the main crate is published.</p>
<h2 id="consequences">Consequences<a class="headerlink" href="#consequences" title="Permanent link">&para;</a></h2>
<h3 id="positive">Positive<a class="headerlink" href="#positive" title="Permanent link">&para;</a></h3>
<ul>
<li>Enables smooth publishing to crates.io</li>
<li>Maintains correct version relationships between published crates</li>
<li>Preserves local development workflow using path dependencies</li>
<li>Ensures that users installing the crate from crates.io get the correct dependency versions</li>
<li>The update scripts reduce maintenance burden</li>
<li>The defined publishing order ensures all dependencies are available when needed</li>
<li>Consistent versioning across all crates in the workspace</li>
</ul>
<h3 id="negative">Negative<a class="headerlink" href="#negative" title="Permanent link">&para;</a></h3>
<ul>
<li>Requires running the update scripts when the workspace version changes</li>
<li>Introduces potential for version mismatch if the scripts are not run</li>
<li>Adds slight complexity to the Cargo.toml file</li>
<li>Requires a specific publishing order that must be maintained in the CI/CD pipeline</li>
</ul>
<h3 id="neutral">Neutral<a class="headerlink" href="#neutral" title="Permanent link">&para;</a></h3>
<ul>
<li>The published crate on crates.io will only use the version specification, as the path specification is removed during publishing</li>
</ul>
<h2 id="implementation">Implementation<a class="headerlink" href="#implementation" title="Permanent link">&para;</a></h2>
<p>The implementation involves:</p>
<ol>
<li>Updating the root <code>Cargo.toml</code> file to include version specifications for all internal dependencies:</li>
</ol>
<div class="language-toml highlight"><pre><span></span><code><span id="__span-3-1"><span class="n">floxide-core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-core&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-3-2"><span class="n">floxide-transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-transform&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-3-3"><span class="n">floxide-event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-event&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-3-4"><span class="n">floxide-timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-timer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-3-5"><span class="n">floxide-longrunning</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-longrunning&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-3-6"><span class="n">floxide-reactive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-reactive&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>Ensuring all subcrates use workspace inheritance for their versions:</li>
</ol>
<div class="language-toml highlight"><pre><span></span><code><span id="__span-4-1"><span class="k">[package]</span>
</span><span id="__span-4-2"><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;floxide-event&quot;</span>
</span><span id="__span-4-3"><span class="n">version</span><span class="p">.</span><span class="n">workspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-4-4"><span class="n">edition</span><span class="p">.</span><span class="n">workspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</span><span id="__span-4-5"><span class="c1"># ...</span>
</span></code></pre></div>
<ol>
<li>Creating a script (<code>scripts/update_dependency_versions.sh</code>) to automatically update the root crate's dependency versions:</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><span class="ch">#!/bin/bash</span>
</span><span id="__span-5-2"><span class="nb">set</span><span class="w"> </span>-e
</span><span id="__span-5-3">
</span><span id="__span-5-4"><span class="c1"># Get the current workspace version from Cargo.toml</span>
</span><span id="__span-5-5"><span class="nv">WORKSPACE_VERSION</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>-m<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="s1">&#39;version = &#39;</span><span class="w"> </span>Cargo.toml<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span>-f<span class="w"> </span><span class="m">2</span><span class="k">)</span>
</span><span id="__span-5-6">
</span><span id="__span-5-7"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Updating dependency versions to match workspace version: </span><span class="nv">$WORKSPACE_VERSION</span><span class="s2">&quot;</span>
</span><span id="__span-5-8">
</span><span id="__span-5-9"><span class="c1"># Update all internal dependency versions in the root Cargo.toml</span>
</span><span id="__span-5-10">sed<span class="w"> </span>-i.bak<span class="w"> </span>-E<span class="w"> </span><span class="s2">&quot;s/(floxide-[a-z]+[[:space:]]*=[[:space:]]*\{[[:space:]]*path[[:space:]]*=[[:space:]]*\&quot;[^\&quot;]+\&quot;,[[:space:]]*version[[:space:]]*=[[:space:]]*\&quot;)[0-9]+\.[0-9]+\.[0-9]+/\1</span><span class="nv">$WORKSPACE_VERSION</span><span class="s2">/g&quot;</span><span class="w"> </span>Cargo.toml
</span><span id="__span-5-11">
</span><span id="__span-5-12"><span class="c1"># Remove backup file</span>
</span><span id="__span-5-13">rm<span class="w"> </span>Cargo.toml.bak
</span><span id="__span-5-14">
</span><span id="__span-5-15"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Dependency versions updated successfully!&quot;</span>
</span><span id="__span-5-16">
</span><span id="__span-5-17"><span class="c1"># Verify the changes</span>
</span><span id="__span-5-18"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Verifying changes...&quot;</span>
</span><span id="__span-5-19">grep<span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;floxide-&quot;</span><span class="w"> </span>Cargo.toml<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;version&quot;</span>
</span><span id="__span-5-20">
</span><span id="__span-5-21"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Done!&quot;</span>
</span></code></pre></div>
<ol>
<li>Creating a script (<code>scripts/update_subcrate_versions.sh</code>) to ensure all subcrates use workspace inheritance:</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><span class="ch">#!/bin/bash</span>
</span><span id="__span-6-2"><span class="nb">set</span><span class="w"> </span>-e
</span><span id="__span-6-3">
</span><span id="__span-6-4"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Updating subcrates to use workspace inheritance for versions...&quot;</span>
</span><span id="__span-6-5">
</span><span id="__span-6-6"><span class="c1"># List of subcrates to check and update</span>
</span><span id="__span-6-7"><span class="nv">SUBCRATES</span><span class="o">=(</span>
</span><span id="__span-6-8"><span class="w">  </span><span class="s2">&quot;floxide-core&quot;</span>
</span><span id="__span-6-9"><span class="w">  </span><span class="s2">&quot;floxide-transform&quot;</span>
</span><span id="__span-6-10"><span class="w">  </span><span class="s2">&quot;floxide-event&quot;</span>
</span><span id="__span-6-11"><span class="w">  </span><span class="s2">&quot;floxide-timer&quot;</span>
</span><span id="__span-6-12"><span class="w">  </span><span class="s2">&quot;floxide-longrunning&quot;</span>
</span><span id="__span-6-13"><span class="w">  </span><span class="s2">&quot;floxide-reactive&quot;</span>
</span><span id="__span-6-14"><span class="o">)</span>
</span><span id="__span-6-15">
</span><span id="__span-6-16"><span class="k">for</span><span class="w"> </span>subcrate<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">SUBCRATES</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-17"><span class="w">  </span><span class="nv">CARGO_FILE</span><span class="o">=</span><span class="s2">&quot;crates/</span><span class="nv">$subcrate</span><span class="s2">/Cargo.toml&quot;</span>
</span><span id="__span-6-18"><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Checking </span><span class="nv">$CARGO_FILE</span><span class="s2">...&quot;</span>
</span><span id="__span-6-19"><span class="w">  </span>
</span><span id="__span-6-20"><span class="w">  </span><span class="c1"># Check if the subcrate is using workspace inheritance for version</span>
</span><span id="__span-6-21"><span class="w">  </span><span class="k">if</span><span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;version.workspace = true&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CARGO_FILE</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-22"><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  ✅ </span><span class="nv">$subcrate</span><span class="s2"> is already using workspace inheritance for version&quot;</span>
</span><span id="__span-6-23"><span class="w">  </span><span class="k">else</span>
</span><span id="__span-6-24"><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  ⚠️ </span><span class="nv">$subcrate</span><span class="s2"> is not using workspace inheritance for version. Updating...&quot;</span>
</span><span id="__span-6-25"><span class="w">    </span>
</span><span id="__span-6-26"><span class="w">    </span><span class="c1"># Get the current version line</span>
</span><span id="__span-6-27"><span class="w">    </span><span class="nv">VERSION_LINE</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>-m<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="s2">&quot;^version = &quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CARGO_FILE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="k">)</span>
</span><span id="__span-6-28"><span class="w">    </span>
</span><span id="__span-6-29"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$VERSION_LINE</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-30"><span class="w">      </span><span class="c1"># Replace the version line with workspace inheritance</span>
</span><span id="__span-6-31"><span class="w">      </span>sed<span class="w"> </span>-i.bak<span class="w"> </span><span class="s2">&quot;s/^version = .*/version.workspace = true/&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CARGO_FILE</span><span class="s2">&quot;</span>
</span><span id="__span-6-32"><span class="w">      </span>rm<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$CARGO_FILE</span><span class="s2">.bak&quot;</span>
</span><span id="__span-6-33"><span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  ✅ Updated </span><span class="nv">$subcrate</span><span class="s2"> to use workspace inheritance for version&quot;</span>
</span><span id="__span-6-34"><span class="w">    </span><span class="k">else</span>
</span><span id="__span-6-35"><span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;  ❌ Could not find version line in </span><span class="nv">$subcrate</span><span class="s2">&quot;</span>
</span><span id="__span-6-36"><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-6-37"><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-6-38"><span class="k">done</span>
</span><span id="__span-6-39">
</span><span id="__span-6-40"><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Done updating subcrates!&quot;</span>
</span></code></pre></div>
<ol>
<li>Maintaining a specific publishing order in our release workflow:</li>
<li>First publish <code>floxide-core</code></li>
<li>Then publish <code>floxide-transform</code></li>
<li>Then publish <code>floxide-event</code></li>
<li>Then publish <code>floxide-timer</code></li>
<li>Then publish <code>floxide-longrunning</code></li>
<li>Then publish <code>floxide-reactive</code></li>
<li>
<p>Finally publish the root <code>floxide</code> crate</p>
</li>
<li>
<p>Integrating both update scripts into our release process to ensure versions are always in sync.</p>
</li>
</ol>
<h3 id="future-improvements">Future Improvements<a class="headerlink" href="#future-improvements" title="Permanent link">&para;</a></h3>
<p>For future consideration:</p>
<ol>
<li>Adding a CI check to ensure that all version specifications match the workspace version</li>
<li>Investigating if Cargo workspace inheritance can be leveraged for this use case in future Rust/Cargo versions</li>
<li>Exploring other approaches to simplify dependency management in workspaces</li>
<li>Automating the publishing process further to reduce manual steps</li>
<li>Adding pre-commit hooks to run the version update scripts automatically</li>
</ol>
<h2 id="related-adrs">Related ADRs<a class="headerlink" href="#related-adrs" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="../0014-crate-publishing-and-cicd/">ADR 0014: Crate Publishing and CI/CD</a></li>
<li><a href="../0029-feature-based-crate-organization/">ADR 0029: Feature-Based Crate Organization</a></li>
</ul>
<h2 id="additional-considerations">Additional Considerations<a class="headerlink" href="#additional-considerations" title="Permanent link">&para;</a></h2>
<h3 id="consistent-version-formats">Consistent Version Formats<a class="headerlink" href="#consistent-version-formats" title="Permanent link">&para;</a></h3>
<p>When specifying versions for internal dependencies in the root crate, it's important to maintain a consistent format. We encountered issues with mixed version formats:</p>
<div class="language-toml highlight"><pre><span></span><code><span id="__span-7-1"><span class="c1"># Inconsistent version formats</span>
</span><span id="__span-7-2"><span class="n">floxide-core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-core&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;1.0.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1"># No equals sign</span>
</span><span id="__span-7-3"><span class="n">floxide-event</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;./crates/floxide-event&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;=1.0.3&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">optional</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span><span class="w">  </span><span class="c1"># With equals sign</span>
</span></code></pre></div>
<p>The <code>update_dependency_versions.sh</code> script has been enhanced to handle both formats:
- Version specifications with no equals sign: <code>version = "1.0.3"</code>
- Version specifications with equals sign: <code>version = "=1.0.3"</code></p>
<p>Additionally, the script now handles cases where the <code>version</code> attribute might appear before the <code>path</code> attribute in the dependency specification.</p>
<h3 id="publishing-order-importance">Publishing Order Importance<a class="headerlink" href="#publishing-order-importance" title="Permanent link">&para;</a></h3>
<p>When publishing to crates.io, all dependencies must have explicit version specifications, even for local path dependencies. If a subcrate is published without all its dependencies having explicit versions, the publish will fail with an error like:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1">error: all dependencies must have a version specified when publishing.
</span><span id="__span-8-2">dependency `floxide-core` does not specify a version
</span></code></pre></div>
<p>This reinforces the importance of:
1. Running the <code>update_dependency_versions.sh</code> script before publishing
2. Following the correct publishing order (subcrates first, then the root crate)
3. Ensuring all version numbers are consistent across the workspace </p>
</section>

            </main>
        </div>
        <hr><footer>
    <div class="terminal-mkdocs-footer-grid">
        <div id="terminal-mkdocs-footer-copyright-info">
             Site built with <a href="http://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/ntno/mkdocs-terminal">Terminal for MkDocs</a>.
        </div>
    </div>
</footer>
    </div>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="alertdialog" aria-modal="true" aria-labelledby="searchModalLabel">
    <div class="modal-dialog modal-lg" role="search">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Search</h5>
                <button type="button" class="close btn btn-default btn-ghost" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p id="searchInputLabel">Type to start searching</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" aria-labelledby="searchInputLabel" placeholder="" id="mkdocs-search-query" title="Please enter search terms here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No document matches found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    
    
</body>

</html>